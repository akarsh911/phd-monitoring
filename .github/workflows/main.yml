name: Trigger Jenkins on Push

on:
  push:
    branches:
      - main  # or change to your deployment branch

jobs:
  trigger-jenkins:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch Jenkins Crumb
        id: get-crumb
        run: |
          echo "🔐 Getting Jenkins Crumb..."
          CRUMB_JSON=$(curl -s -u "${{ secrets.JENKINS_USER }}:${{ secrets.JENKINS_API_TOKEN }}" \
            https://phdportal.thapar.edu/admin/jenkins/crumbIssuer/api/json)

          CRUMB=$(echo "$CRUMB_JSON" | jq -r '.crumb')
          echo "crumb=$CRUMB" >> $GITHUB_OUTPUT

      - name: Trigger Jenkins Job
        run: |
          echo "🚀 Triggering Jenkins job..."
          curl -X POST https://phdportal.thapar.edu/admin/jenkins/job/cicd/build \
            -H "Jenkins-Crumb: ${{ steps.get-crumb.outputs.crumb }}" \
            --user "${{ secrets.JENKINS_USER }}:${{ secrets.JENKINS_API_TOKEN }}"
